name: Check GHCR Caddy Releases and Trigger Build

on:
  schedule:
    - cron: '0 1 * * *'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  check_and_trigger:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: read
    steps:
      - name: Get latest Caddy release tag
        id: caddy_release
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const release = await github.rest.repos.getLatestRelease({
              owner: 'caddyserver',
              repo: 'caddy'
            });
            const tag = release.data.tag_name;
            core.setOutput('tag', tag);
            console.log(`Latest Caddy release: ${tag}`);
            
      - name: Check if GHCR image exists for this tag
        id: ghcr_check
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const tag = '${{ steps.caddy_release.outputs.tag }}';
            // GHCR package name is repo name, type is 'container'
            try {
              // List package versions (tags)
              const versions = await github.rest.packages.getAllPackageVersionsForPackageOwnedByOrg({
                package_type: 'container',
                package_name: repo,
                org: owner,
                per_page: 100
              });
              const found = versions.data.some(v => v.metadata.container.tags.includes(tag));
              core.setOutput('exists', found ? 'true' : 'false');
              console.log(`GHCR image for tag ${tag} exists: ${found}`);
            } catch (e) {
              // fallback for user-owned repos
              if (e.status === 404) {
                try {
                  const versions = await github.rest.packages.getAllPackageVersionsForPackageOwnedByUser({
                    package_type: 'container',
                    package_name: repo,
                    username: owner,
                    per_page: 100
                  });
                  const found = versions.data.some(v => v.metadata.container.tags.includes(tag));
                  core.setOutput('exists', found ? 'true' : 'false');
                  console.log(`GHCR image for tag ${tag} exists: ${found}`);
                } catch (err) {
                  core.setOutput('exists', 'false');
                  console.log(`Could not find GHCR image for tag ${tag}: ${err.message}`);
                }
              } else {
                core.setOutput('exists', 'false');
                console.log(`Could not find GHCR image for tag ${tag}: ${e.message}`);
              }
            }

      - name: Trigger Build Workflow if Needed
        if: steps.ghcr_check.outputs.exists != 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const version = '${{ steps.caddy_release.outputs.tag }}';
            console.log(`Build required for Caddy version: ${version}. Dispatching event...`);
            await github.rest.repos.createDispatchEvent({
              owner: context.repo.owner,
              repo: context.repo.repo,
              event_type: 'caddy-release',
              client_payload: {
                caddy_version: version
              }
            });
            console.log(`Successfully dispatched event for ${version}.`);
